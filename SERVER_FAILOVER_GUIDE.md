# 服务器故障转移指南

## 功能概述

已修改信令系统，实现**自动服务器故障转移**功能。当默认服务器不可用时，系统会自动切换到公用备用服务器。

## 核心改动

### 1. **signaling.js** - 新增故障转移逻辑

#### 新增配置
```javascript
const DEFAULT_SIGNALING_URL = `${protocol}//${window.location.host}`;  // 默认服务器（本地）

const PUBLIC_SERVERS = [
    // 暂无可用公用服务器
];

const MAX_ATTEMPTS = 3;  // 最多尝试次数
```

#### 连接流程
1. **优先连接**：尝试连接默认服务器（本地）
2. **自动转移**：如果默认服务器连接失败，自动切换到公用服务器
3. **重试机制**：
   - 每个服务器有 5 秒超时
   - 最多尝试 3 次（包括所有服务器）
   - 失败后自动进行下一次尝试

#### 新增回调
```javascript
onConnected(serverUrl)  // 连接成功时触发，返回当前使用的服务器 URL
onError(errorMsg)       // 所有服务器都无法连接时触发
```

#### 新增方法
```javascript
export function getCurrentServerUrl()  // 获取当前连接的服务器地址
```

### 2. **main.js** - 增强连接状态反馈

#### setupDiscovery 函数更新
- 添加 `onConnected` 回调，记录连接的服务器
- 添加 `onError` 回调，处理发现服务错误

#### joinBtn 点击处理更新
- 添加 `onConnected` 回调，在 UI 显示服务器状态
- 区分显示"本地服务器"和"公用服务器"

示例反馈：
```
✅ 已连接到本地服务器
✅ 已连接到公用服务器
```

## 工作流程图

```
连接请求
    ↓
尝试默认服务器（本地）
    ├─ 成功 → ✅ 使用本地服务器
    └─ 失败（超时/连接错误）
        ↓
    尝试公用服务器 #1
        ├─ 成功 → ✅ 使用公用服务器
        └─ 失败
            ↓
        尝试公用服务器 #2
            ├─ 成功 → ✅ 使用公用服务器
            └─ 失败
                ↓
            所有重试次数用尽 → ❌ 显示错误信息
```

## 使用场景

### 场景 1：本地服务器在线
- 自动连接到本地服务器（延迟最低）
- 用户看到："✅ 已连接到本地服务器"

### 场景 2：本地服务器离线
- 自动检测连接失败
- 自动尝试公用服务器
- 连接成功后，用户看到："✅ 已连接到公用服务器"
- 整个过程自动进行，用户无需手动干预

### 场景 3：网络故障
- 所有服务器都无法连接
- 显示错误信息："无法连接到任何服务器，已尝试 3 次"
- 用户可以点击"加入"重新尝试

## 配置修改

如需修改公用服务器列表或尝试次数，在 **signaling.js** 中修改：

```javascript
// 修改备用服务器列表
const PUBLIC_SERVERS = [
    'wss://your-server-1.com',
    'wss://your-server-2.com',
];

// 修改最大尝试次数（默认 3）
const MAX_ATTEMPTS = 5;
```

## 浏览器兼容性

- 需要支持 WebSocket API
- 现代浏览器均支持（Chrome, Firefox, Safari, Edge）
- 移动浏览器也完全支持

## 调试

### 查看连接日志
打开浏览器开发者工具（F12），在 Console 标签页查看：

```
尝试连接到服务器 (尝试 1/3): ws://localhost:8080
✅ 成功连接到: ws://localhost:8080

或

尝试连接到服务器 (尝试 1/3): ws://localhost:8080
连接超时: ws://localhost:8080
默认服务器连接失败，尝试切换到公用服务器
尝试连接到服务器 (尝试 2/3): wss://echo.websocket.org
✅ 成功连接到: wss://echo.websocket.org
```

### 获取当前服务器
在控制台执行：
```javascript
import * as Signaling from './js/signaling.js';
console.log(Signaling.getCurrentServerUrl());
```

## 注意事项

1. **公用服务器延迟**：公用服务器可能有更高的延迟，但确保应用可用性
2. **服务器功能**：当前公用服务器仅用于测试，生产环境建议部署专属服务器
3. **安全性**：使用 `wss://`（WebSocket Secure）确保连接加密
4. **地域选择**：根据用户分布选择地理位置合适的备用服务器

## 后续改进建议

1. 添加服务器健康检查（定期 ping 检测）
2. 实现服务器性能监测（选择延迟最低的）
3. 支持动态服务器列表配置（从远程服务器获取）
4. 添加连接统计和分析
