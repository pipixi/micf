<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>麦克疯</title>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="app-container">
        <!-- Header Bar -->
        <header class="app-header">
            <div class="header-content">
                <h1>🎙️ 麦克疯</h1>
                <button id="themeToggle" class="theme-toggle" title="切换主题">🌙</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Join Section Card -->
            <div id="joinSection" class="card">
                <div class="card-header">
                    <h2>加入房间</h2>
                    <p class="subtitle">输入房间名开始实时音频通话</p>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <label for="roomId">房间 ID</label>
                        <input type="text" id="roomId" placeholder="输入房间名..." value="default">
                    </div>
                    <button id="joinBtn" class="btn-primary">
                        <span>🚀</span> 加入房间
                    </button>
                    <div id="status" class="status-bar">准备就绪</div>
                </div>

                <!-- Room List -->
                <div id="roomListSection" class="room-list-section hidden">
                    <div class="divider"></div>
                    <h3 class="section-title">🏠 附近房间</h3>
                    <div id="roomList" class="room-list">
                        <!-- Rooms will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Role Selection Card -->
            <div id="roleSection" class="card hidden">
                <div class="card-header">
                    <h2>选择模式</h2>
                    <p class="subtitle">选择你在通话中的角色</p>
                </div>
                <div class="card-body role-buttons">
                    <button id="roleSenderBtn" class="role-card sender">
                        <span class="role-icon">🎙️</span>
                        <span class="role-title">广播模式</span>
                        <span class="role-desc">分享你的麦克风</span>
                    </button>
                    <button id="roleReceiverBtn" class="role-card receiver">
                        <span class="role-icon">🎧</span>
                        <span class="role-title">收听模式</span>
                        <span class="role-desc">接收音频播放</span>
                    </button>
                </div>
            </div>

            <!-- Sender Interface Card -->
            <div id="senderSection" class="card hidden">
                <div class="card-header">
                    <h2>🎙️ 广播模式</h2>
                    <p class="subtitle">正在分享你的麦克风</p>
                </div>
                <div class="card-body">
                    <div class="visualizer-container" id="visualizer">
                        <canvas id="audioVisualizer" width="300" height="50"></canvas>
                    </div>

                    <!-- Audio Optimization Settings -->
                    <div class="experimental-section">
                        <label>🛡️ 音频优化</label>
                        <div class="toggle-group">
                            <div class="toggle-item">
                                <input type="checkbox" id="echoCancellation" checked>
                                <label for="echoCancellation" class="toggle-label">回声消除</label>
                            </div>
                            <div class="toggle-item">
                                <input type="checkbox" id="noiseSuppression" checked>
                                <label for="noiseSuppression" class="toggle-label">噪声抑制</label>
                            </div>
                            <div class="toggle-item">
                                <input type="checkbox" id="autoGainControl" checked>
                                <label for="autoGainControl" class="toggle-label">自动增益</label>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="qualitySelect">音频质量</label>
                        <select id="qualitySelect">
                            <option value="high">高品质 (128kbps)</option>
                            <option value="standard" selected>标准 (64kbps)</option>
                            <option value="low">低品质 (32kbps)</option>
                        </select>
                    </div>

                    <button id="startBtn" class="btn-primary">📡 开始发送</button>
                    <button id="pauseBtn" class="secondary hidden">⏸️ 暂停 (Mute)</button>
                    <div class="recording-controls">
                        <button id="senderRecordBtn" class="record-btn">🔴 开始录音</button>
                        <span id="senderRecordTimer" class="record-timer hidden">00:00</span>
                    </div>
                    <button id="hangupBtn" class="danger">❌ 结束通话</button>
                </div>
            </div>

            <!-- Receiver Interface Card -->
            <div id="receiverSection" class="card hidden">
                <div class="card-header">
                    <h2>🎧 收听模式</h2>
                    <p class="subtitle">正在接收音频</p>
                </div>
                <div class="card-body">
                    <div class="visualizer-container">
                        <div class="bar" style="animation-duration: 1.2s;"></div>
                        <div class="bar" style="animation-duration: 0.8s;"></div>
                        <div class="bar" style="animation-duration: 1.0s;"></div>
                        <div class="bar" style="animation-duration: 0.9s;"></div>
                        <div class="bar" style="animation-duration: 1.1s;"></div>
                    </div>

                    <audio id="remoteAudio" autoplay playsinline style="position:fixed; left:-9999px;"></audio>

                    <div class="input-group">
                        <label for="volumeSlider">🔊 音量调节</label>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
                    </div>

                    <div class="recording-controls">
                        <button id="receiverRecordBtn" class="record-btn">🔴 开始录音</button>
                        <span id="receiverRecordTimer" class="record-timer hidden">00:00</span>
                    </div>

                    <button id="receiverHangupBtn" class="danger">❌ 断开连接</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module" src="js/main.js"></script>
    <script>
        // Theme Toggle
        (function () {
            const themeToggle = document.getElementById('themeToggle');
            const root = document.documentElement;

            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                root.classList.add('dark-theme');
                themeToggle.textContent = '☀️';
            } else if (savedTheme === 'light') {
                root.classList.add('light-theme');
                themeToggle.textContent = '🌙';
            } else {
                // Auto mode - check system preference for icon
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    themeToggle.textContent = '☀️';
                }
            }

            themeToggle.addEventListener('click', () => {
                const isDark = root.classList.contains('dark-theme') ||
                    (!root.classList.contains('light-theme') &&
                        window.matchMedia('(prefers-color-scheme: dark)').matches);

                if (isDark) {
                    // Switch to light
                    root.classList.remove('dark-theme');
                    root.classList.add('light-theme');
                    themeToggle.textContent = '🌙';
                    localStorage.setItem('theme', 'light');
                } else {
                    // Switch to dark
                    root.classList.remove('light-theme');
                    root.classList.add('dark-theme');
                    themeToggle.textContent = '☀️';
                    localStorage.setItem('theme', 'dark');
                }
            });
        })();

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('SW Registered'))
                .catch(err => console.error('SW Error:', err));
        }
    </script>
</body>

</html>