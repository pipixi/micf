<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>麦克疯</title>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="assets/icon-192.png" type="image/png">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/icon-192.png">

    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="app-container">
        <!-- Header Bar -->
        <header class="app-header">
            <div class="header-content">
                <h1 data-i18n="app_title">🎙️ 麦克疯</h1>
                <div class="header-actions">
                    <div class="lang-dropdown">
                        <button id="langToggle" class="theme-toggle" title="Switch Language">🌐</button>
                        <div id="langMenu" class="lang-menu">
                            <button class="lang-option" data-lang="zh">简体中文</button>
                            <button class="lang-option" data-lang="en">English</button>
                        </div>
                    </div>
                    <button id="themeToggle" class="theme-toggle" title="切换主题">🌙</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Join Section Card -->
            <div id="joinSection" class="card">
                <div class="card-header">
                    <h2 data-i18n="join_room_title">加入房间</h2>
                    <p class="subtitle" data-i18n="join_room_subtitle">输入房间名开始实时音频通话</p>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <label for="roomId" data-i18n="room_id">房间 ID</label>
                        <input type="text" id="roomId" data-i18n-placeholder="room_placeholder" placeholder="输入房间名..."
                            value="default">
                    </div>
                    <button id="joinBtn" class="btn-primary" data-i18n="join_btn">
                        <span>🚀</span> 加入房间
                    </button>
                    <div id="status" class="status-bar" data-i18n="status_ready">准备就绪</div>
                </div>

                <!-- Room List -->
                <div id="roomListSection" class="room-list-section hidden">
                    <div class="divider"></div>
                    <h3 class="section-title" data-i18n="nearby_rooms">🏠 附近房间</h3>
                    <div id="roomList" class="room-list">
                        <!-- Rooms will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Role Selection Card -->
            <div id="roleSection" class="card hidden">
                <div class="card-header">
                    <h2 data-i18n="select_mode_title">选择模式</h2>
                    <p class="subtitle" data-i18n="select_mode_subtitle">选择你在通话中的角色</p>
                </div>
                <div class="card-body role-buttons">
                    <button id="roleSenderBtn" class="role-card sender">
                        <span class="role-icon">🎙️</span>
                        <span class="role-title" data-i18n="broadcast_mode">广播模式</span>
                        <span class="role-desc" data-i18n="broadcast_desc">分享你的麦克风</span>
                    </button>
                    <button id="roleReceiverBtn" class="role-card receiver">
                        <span class="role-icon">🎧</span>
                        <span class="role-title" data-i18n="listen_mode">收听模式</span>
                        <span class="role-desc" data-i18n="listen_desc">接收音频播放</span>
                    </button>
                </div>
            </div>

            <!-- Sender Interface Card -->
            <div id="senderSection" class="card hidden">
                <div class="card-header">
                    <h2 data-i18n="sender_title">🎙️ 广播模式</h2>
                    <p class="subtitle" data-i18n="sender_subtitle">正在分享你的麦克风</p>
                </div>
                <div class="card-body">
                    <div class="visualizer-container" id="visualizer">
                        <canvas id="audioVisualizer" width="300" height="50"></canvas>
                    </div>

                    <!-- Audio Mode Selection -->
                    <div class="input-group">
                        <label data-i18n="audio_mode">🎧 音频模式</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="audioMode" value="speech" checked>
                                <span data-i18n="speech_mode">🗣️ 人声模式 (会议/聊天)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="audioMode" value="music">
                                <span data-i18n="music_mode">🎵 音乐模式 (高保真)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Audio Optimization Settings -->
                    <div class="experimental-section">
                        <label data-i18n="audio_opt">🛡️ 音频优化</label>
                        <div class="toggle-group">
                            <div class="toggle-item">
                                <input type="checkbox" id="echoCancellation" checked>
                                <label for="echoCancellation" class="toggle-label" data-i18n="echo_cancel">回声消除</label>
                            </div>
                            <div class="toggle-item">
                                <input type="checkbox" id="noiseSuppression" checked>
                                <label for="noiseSuppression" class="toggle-label" data-i18n="noise_supp">噪声抑制</label>
                            </div>
                            <div class="toggle-item">
                                <input type="checkbox" id="autoGainControl" checked>
                                <label for="autoGainControl" class="toggle-label" data-i18n="auto_gain">自动增益</label>
                            </div>
                        </div>
                    </div>



                    <div class="source-management">
                        <label data-i18n="audio_source">🔊 音频源</label>
                        <div id="sourceList" class="source-list"></div>
                        <button id="addSystemAudioBtn" class="secondary" style="margin-top:8px;"
                            data-i18n="add_system_audio">
                            🖥️ 添加系统声音 (共享屏幕/标签页)
                        </button>
                    </div>

                    <div class="divider"></div>

                    <button id="startBtn" class="btn-primary" data-i18n="start_sending">📡 开始发送</button>
                    <button id="pauseBtn" class="secondary hidden" data-i18n="pause_mute">⏸️ 暂停 (Mute)</button>
                    <div class="recording-controls">
                        <button id="senderRecordBtn" class="record-btn" data-i18n="start_recording">🔴 开始录音</button>
                        <span id="senderRecordTimer" class="record-timer hidden">00:00</span>
                    </div>
                    <button id="hangupBtn" class="danger" data-i18n="end_call">❌ 结束通话</button>
                </div>
            </div>

            <!-- Receiver Interface Card -->
            <div id="receiverSection" class="card hidden">
                <div class="card-header">
                    <h2 data-i18n="receiver_title">🎧 收听模式</h2>
                    <p class="subtitle" data-i18n="receiver_subtitle">正在接收音频</p>
                </div>
                <div class="card-body">
                    <div class="visualizer-container">
                        <div class="bar" style="animation-duration: 1.2s;"></div>
                        <div class="bar" style="animation-duration: 0.8s;"></div>
                        <div class="bar" style="animation-duration: 1.0s;"></div>
                        <div class="bar" style="animation-duration: 0.9s;"></div>
                        <div class="bar" style="animation-duration: 1.1s;"></div>
                    </div>

                    <audio id="remoteAudio" autoplay playsinline style="position:fixed; left:-9999px;"></audio>

                    <div class="input-group">
                        <label for="audioOutputSelect" data-i18n="output_device">🔊 输出设备</label>
                        <select id="audioOutputSelect">
                            <option value="default" data-i18n="default_device">默认设备</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="volumeSlider" data-i18n="volume_control">🔊 音量调节</label>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
                    </div>

                    <div class="recording-controls">
                        <button id="receiverRecordBtn" class="record-btn" data-i18n="start_recording">🔴 开始录音</button>
                        <span id="receiverRecordTimer" class="record-timer hidden">00:00</span>
                    </div>

                    <button id="receiverHangupBtn" class="danger" data-i18n="disconnect">❌ 断开连接</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module" src="js/main.js"></script>
    <script>
        // Theme Toggle
        (function () {
            const themeToggle = document.getElementById('themeToggle');
            const root = document.documentElement;

            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                root.classList.add('dark-theme');
                themeToggle.textContent = '☀️';
            } else if (savedTheme === 'light') {
                root.classList.add('light-theme');
                themeToggle.textContent = '🌙';
            } else {
                // Auto mode - check system preference for icon
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    themeToggle.textContent = '☀️';
                }
            }

            themeToggle.addEventListener('click', () => {
                const isDark = root.classList.contains('dark-theme') ||
                    (!root.classList.contains('light-theme') &&
                        window.matchMedia('(prefers-color-scheme: dark)').matches);

                if (isDark) {
                    // Switch to light
                    root.classList.remove('dark-theme');
                    root.classList.add('light-theme');
                    themeToggle.textContent = '🌙';
                    localStorage.setItem('theme', 'light');
                } else {
                    // Switch to dark
                    root.classList.remove('light-theme');
                    root.classList.add('dark-theme');
                    themeToggle.textContent = '☀️';
                    localStorage.setItem('theme', 'dark');
                }
            });
        })();

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('SW Registered'))
                .catch(err => console.error('SW Error:', err));
        }
    </script>
</body>

</html>